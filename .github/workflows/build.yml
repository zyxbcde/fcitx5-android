name: Build APK

on:
  push:
    branches: [master, main]
    paths:
      - 'app/**'
      - 'lib/**'
      - 'build-logic/**'
      - '.github/workflows/build-apk.yml'
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        abi: [arm64-v8a]
        build_type: [Release]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y extra-cmake-modules gettext
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      

      - name: Build and Sign APK
        run: |
          echo "Building and signing ${{ matrix.build_type }} APK for ABI: ${{ matrix.abi }}"
          
          # 生成调试密钥（如果不存在）
          keytool -genkey -v -keystore debug.keystore -alias androiddebugkey \
            -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android \
            -dname "CN=Android Debug,O=Android,C=US"
          
          # 构建并签名
          ./gradlew :app:assemble${{ matrix.build_type }} \
            -Pandroid.injected.signing.store.file=$(pwd)/debug.keystore \
            -Pandroid.injected.signing.store.password=android \
            -Pandroid.injected.signing.key.alias=androiddebugkey \
            -Pandroid.injected.signing.key.password=android \
            -Pandroid.injected.build.abi=${{ matrix.abi }} \
            --no-daemon \
            --stacktrace
            
      - name: Find and list build outputs
        run: |
          echo "=== 查找所有 APK/AAB 文件 ==="
          find . -name "*.apk" -o -name "*.aab" | head -20
          
          echo "=== 查看 build 目录结构 ==="
          find ./app/build -type f -name "*.apk" -o -name "*.aab" | head -20
          
          echo "=== 查看 outputs 目录 ==="
          find . -path "*/outputs/*" -type d 2>/dev/null | head -10
      - name: Upload specific APK artifacts
        uses: actions/upload-artifact@v4
        if: always()  # 即使构建失败也上传，方便调试
        with:
          name: apk-${{ matrix.abi }}-${{ matrix.build_type }}
          path: |
            app/build/intermediates/apk/release/*.apk
            app/build/intermediates/apk/release/*.aab
          retention-days: 30

      - name: Upload entire project as backup
        uses: actions/upload-artifact@v4
        if: always()  # 总是上传，确保有完整文件
        with:
          name: full-project-backup-${{ matrix.abi }}-${{ matrix.build_type }}
          path: .
          retention-days: 30
